<!DOCTYPE html>
<html>
<head>
    <title>Movie Reviews</title>

    <!-- Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- Custom CSS -->
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>

<body class="dark-mode">

<!-- ===== NAVBAR ===== -->
<nav class="navbar-custom">
    <div class="nav-left">
        <h2 class="logo">üé¨ MovieBase</h2>
    </div>

    <div class="nav-right">
        {% if session.get('user') %}
            <span class="welcome-text">Hi, {{ session['user'] }}</span>
            <a href="/logout" class="nav-btn logout-btn">Logout</a>
        {% else %}
            <a href="/login" class="nav-btn login-btn">Login</a>
        {% endif %}
    </div>
</nav>

<!-- ===== HERO ===== -->
<div class="hero-section">
    <div class="hero-overlay">
        <h1>üé¨ Discover. Review. Rate.</h1>
        <p>Track your favorite movies in style.</p>
        {% if session.get('user') %}
<a href="{{ url_for('add_movie') }}" class="hero-btn">
    + Add Your Review
</a>
{% else %}
<a href="{{ url_for('login') }}" class="hero-btn">
    üîê Login to Review
</a>
{% endif %}
        </a>
    </div>
</div>

<!-- ===== FLASH ===== -->
{% with messages = get_flashed_messages(with_categories=true) %}
{% if messages %}
<div class="flash-container">
    {% for category, message in messages %}
    <div class="flash-{{ category }}">{{ message }}</div>
    {% endfor %}
</div>
{% endif %}
{% endwith %}

<!-- ===== STATS ===== -->
<div class="stats-box">
    <p><strong>Total Movies:</strong> {{ total_movies }}</p>
    <p><strong>Average Rating:</strong> ‚≠ê {{ average_rating }}</p>

    {% if highest_rated %}
    <p>
        <strong>Highest Rated:</strong>
        {{ highest_rated.name }} (‚≠ê {{ highest_rated.rating }})
    </p>
    {% endif %}
</div>

<!-- ===== SEARCH + FILTER ===== -->
<form method="GET" action="{{ url_for('index') }}" class="filter-box">

    <input type="text"
           name="search"
           placeholder="Search movie..."
           value="{{ search_query or '' }}">

    <select name="sort">
        <option value="">Sort by rating</option>
        <option value="high" {% if sort_option == "high" %}selected{% endif %}>
            ‚≠ê High ‚Üí Low
        </option>
        <option value="low" {% if sort_option == "low" %}selected{% endif %}>
            ‚≠ê Low ‚Üí High
        </option>
    </select>

    <select name="min_rating">
        <option value="">Min Rating</option>
        {% for i in range(1,6) %}
        <option value="{{ i }}"
            {% if min_rating == i|string %}selected{% endif %}>
            ‚≠ê {{ i }}+
        </option>
        {% endfor %}
    </select>

    <select name="max_rating">
        <option value="">Max Rating</option>
        {% for i in range(1,6) %}
        <option value="{{ i }}"
            {% if max_rating == i|string %}selected{% endif %}>
            Up to ‚≠ê {{ i }}
        </option>
        {% endfor %}
    </select>

    <button type="submit">Apply</button>
    <a href="{{ url_for('index') }}" class="clear-button">Clear</a>
</form>

<!-- ===== MOVIES ===== -->
<div class="movies-container">
{% if movies %}
    {% for movie in movies %}
        <div class="movie-card">

            {% if movie.poster %}
                <img src="{{ movie.poster }}" 
                     alt="Movie Poster" 
                     class="poster-img">
            {% else %}
                <div class="no-poster">
                    üé¨ No Poster
                </div>
            {% endif %}

            <div class="movie-info">

                <h3>{{ movie.name }}</h3>

                <p class="text-muted small">
                    Added: {{ movie.created_at[:16] }}
                </p>

                {% if movie.updated_at != movie.created_at %}
                <p class="text-warning small fst-italic">
                    üìù Last updated: {{ movie.updated_at }}
                </p>
                {% endif %}

                <span class="rating-badge rating-{{ movie.rating }}">
                    ‚≠ê {{ movie.rating }}
                </span>

                <p class="movie-review">
                    {{ movie.review }}
                </p>

                <div class="action-buttons">
                    <a href="{{ url_for('edit_movie', id=movie.id) }}" class="edit-btn">
                        ‚úè Edit
                    </a>

                    <button type="button" 
                            class="delete-btn"
                            onclick="openModal({{ movie.id }})">
                        üóë Delete
                    </button>
                </div>

            </div>
        </div>
    {% endfor %}
{% else %}
    <div class="empty-box">
        <h3>No Movies Found</h3>
        <p>Try adjusting filters or add a new movie.</p>
    </div>
{% endif %}
</div>

<!-- ===== PAGINATION ===== -->
<div class="pagination">
    {% if page > 1 %}
    <a href="{{ url_for('index',
                        page=page-1,
                        search=search_query,
                        sort=sort_option,
                        min_rating=min_rating,
                        max_rating=max_rating) }}">
        &laquo; Previous
    </a>
    {% endif %}

    <span>Page {{ page }} of {{ total_pages }}</span>

    {% if page < total_pages %}
    <a href="{{ url_for('index',
                        page=page+1,
                        search=search_query,
                        sort=sort_option,
                        min_rating=min_rating,
                        max_rating=max_rating) }}">
        Next &raquo;
    </a>
    {% endif %}
</div>


<!-- ===== DELETE MODAL ===== -->
<div id="deleteModal" class="modal">
    <div class="modal-content">
        <h3>Delete Movie?</h3>
        <p>Are you sure you want to delete this review?</p>

        <div class="modal-actions">
            <button class="cancel-btn" onclick="closeModal()">Cancel</button>

            <form id="deleteForm" method="POST">
                <button type="submit" class="confirm-delete-btn">
                    Yes, Delete
                </button>
            </form>
        </div>
    </div>
</div>


<script>
function openModal(movieId) {
    const modal = document.getElementById("deleteModal");
    const form = document.getElementById("deleteForm");

    form.action = "/delete/" + movieId;
    modal.style.display = "flex";
}

function closeModal() {
    document.getElementById("deleteModal").style.display = "none";
}
</script>


</body>
</html>